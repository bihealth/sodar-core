{% extends 'projectroles/project_base.html' %}

{% load rules %}
{% load projectroles_tags %}
{% load projectroles_role_tags %}
{% load projectroles_common_tags %}
{% block title %}Members of {{ project.title }}{% endblock title %}

{% block css %}

{{ block.super }}
<style type="text/css">
  table#sodar-pr-role-list-table tbody td:nth-child(5) {
    width: 3em;
  }
  /* Responsive modifications */
  @media screen and (max-width: 1000px) {
    .table#sodar-pr-role-list-table thead tr th:nth-child(2),
    .table#sodar-pr-role-list-table tbody tr td:nth-child(2) {
        display: none;
    }
  }
  @media screen and (max-width: 750px) {
      .table#sodar-pr-role-list-table thead tr th:nth-child(3),
      .table#sodar-pr-role-list-table tbody tr td:nth-child(3) {
          display: none;
      }
  }
</style>

{% endblock css %}

{% block projectroles_extend %}

{% get_role_perms project request.user as role_perms %}

<div class="row sodar-subtitle-container bg-white sticky-top">
  <h3>
    <i class="iconify" data-icon="mdi:account-multiple"></i>
    {% get_display_name project.type title=True %} Members
  </h3>
  {% if role_perms.can_update_members or role_perms.can_invite %}
    {% include 'projectroles/_role_list_buttons.html' %}
  {% endif %}
</div>

<div class="container-fluid sodar-page-container">
  {% if project.is_remote %}
    {% if role_perms.can_update_members or role_perms.can_invite %}
      <div class="alert alert-info">
        This is a remote project. You can only update or invite members on the
        source site of this project.
        <a href="{{ remote_roles_url }}" target="_blank">
          Click here to access member management.
        </a>
      </div>
    {% endif %}
  {% endif %}

  <div class="card" id="sodar-pr-role-list">
    <div class="card-body p-0">
      <table class="table table-striped sodar-card-table"
             id="sodar-pr-role-list-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for role_as in roles %}
            <tr class="sodar-pr-role-list-row" data-user-uuid="{{ role_as.user.sodar_uuid }}">
              <td>{{ role_as.user.username }}</td>
              <td>{{ role_as.user.name }}</td>
              <td><a href="mailto:{{ role_as.user.email }}">{{ role_as.user.email }}</a></td>
              <td>
                {% get_role_display_name role_as project title=True as role_display %}
                {% if role_as.project != project %}
                  <i class="iconify text-primary" data-icon="mdi:arrow-down-circle"></i>
                  <a href="{% url 'projectroles:roles' project=role_as.project.sodar_uuid %}"
                     title="Role inherited from {{ role_as.project.title }}"
                     data-toggle="tooltip" data-placement="top">
                    {{ role_display }}
                  </a>
                {% else %}
                  <i class="iconify" data-icon="{% get_role_icon role_as.role %}"></i>
                  {{ role_display }}
                {% endif %}
              </td>
              <td>
                {% display_role_buttons project role_as role_perms as can_display_buttons %}
                {% if can_display_buttons %}
                  {% if role_as.role.name == 'project owner' %}
                    {% include 'projectroles/_project_roles_buttons_owner.html' with user=role_as.user role_as_uuid=role_as.sodar_uuid %}
                  {% else %}
                    {% include 'projectroles/_project_roles_buttons.html' with user=role_as.user role_as_uuid=role_as.sodar_uuid %}
                  {% endif %}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock projectroles_extend %}

{% block javascript %}
  {{ block.super }}

  <!-- Tour content -->
  <script type="text/javascript">
    tourEnabled = true;

    tour.addStep('role_list', {
        title: 'Members List',
        text: 'List of users given access for this ' +
            '{% get_display_name "PROJECT" %} can be seen here.',
        attachTo: '#sodar-pr-role-list top',
        advanceOn: '.docs-link click',
        showCancelLink: true
    });

    if ($('#sodar-pr-btn-role-list').length) {
        tour.addStep('role_actions', {
            title: 'Member Operations Menu',
            text: 'Use this menu to add members, send invites or view existing ' +
                'invites.',
            attachTo: '#sodar-pr-btn-role-list left',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });
    }

    if ($('div.pr_role_buttons').length) {
        tour.addStep('role_menu', {
            title: 'Member Editing Menu',
            text: 'Individual memberships can be updated or removed from these ' +
                'menues.',
            attachTo: 'div.sodar-pr-btn-grp-role left',
            advanceOn: '.docs-link click',
            showCancelLink: true,
            scrollTo: true
        });
    }
  </script>
{% endblock javascript %}
